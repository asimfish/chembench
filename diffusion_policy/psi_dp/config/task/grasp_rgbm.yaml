# name: grasp_rgbm
# name: pick_place_rgbm
name: handover_rgbm
# ==================== 数据集配置（需要修改的部分）====================
# 物体名称 - 用于输出文件夹命名和wandb记录
# object_name: "RBG6_第一批_250ml玻璃烧杯_带第三人称相机"
# object_name: "100ml玻璃烧杯_黑色_无速度_rgb+normal+depth_batch${dataloader.batch_size}_action${n_action_steps}"


# object_name: "Grasp_RGBM_第四批_棕色试剂瓶小"

# object_name: "Pick_Place_第二批_ND_棕色试剂瓶(大)"
object_name: "Handover_ND_100ml玻璃量筒"

# object_name: "Pick_Place_RGBM_第二批_棕色试剂瓶(大)"


num_demos: 50  # 修改这里：数据条数，0表示自动检测

# 数据集根目录
data_root: /share_data/liyufeng/code/chembench/data/zarr_rgbm/motion_plan/grasp
# 完整数据集路径 = data_root / object_name.zarr
dataset_path: "/share_data/liyufeng/code/chembench/data/final_real/data/handover/100ml玻璃量筒.zarr"

# ==================== 数据采集时的随机化配置 ====================
# 这些配置用于记录数据采集时的随机化设置，便于实验对比
randomization:
  # 位置随机化
  position:
    enabled: true
    x_range: [-0.02, 0.02]  # X轴随机范围(米)
    y_range: [-0.02, 0.02]  # Y轴随机范围(米)
    z_range: [0.0, 0.0]     # Z轴随机范围(米)
  # 旋转随机化
  rotation:
    enabled: false
    yaw_range: [-26, 26]    # 偏航角随机范围(度)
  # 其他随机化
  lighting: false           # 光照随机化
  texture: false            # 纹理随机化

# ==================== 观测配置开关 ====================
# 【重要】修改 obs_mode 后，需要同步修改下方的 image_channels！
# 
# 图像观测模式对照表:
#   obs_mode           image_channels    描述
#   ---------------    --------------    ----
#   "rgb"              3                 纯 RGB 3通道
#   "rgbm"             4                 RGB + Mask 4通道
#   "rgb_masked"       3                 RGB * Mask 3通道 (背景置黑)
#   "rgb_masked_rgb"   6                 RGB + RGB*Mask 6通道 (原始RGB + 背景置黑RGB)
#   "nd"               4                 Normal + Depth 4通道
#   "rgbnd"            7                 RGB + Normal + Depth 7通道
#
obs_config:
  obs_mode: "nd"       # 选择: rgb, rgbm, rgb_masked, rgb_masked_rgb, nd, rgbnd
  use_velocity: false   # 是否使用速度观测 (arm2_vel, hand2_vel, arm1_vel, hand1_vel)
  use_third_camera: true  # 是否使用第三人称相机
  use_left_hand: true  # 是否使用左手观测 (arm1_pos, hand1_pos, arm1_eef_pos, arm1_eef_quat)

# ==================== 数据信息 ====================
data_info:
  obs_type: ${task.obs_config.obs_mode}  # 从 obs_config 继承
  # 根据 use_velocity、use_third_camera 和 use_left_hand 选择不同的 obs_keys
  # 基础配置（仅右手）:
  # obs_keys: ["chest_camera_rgb", "head_camera_rgb", "arm2_pos", "hand2_pos", "arm2_eef_pos", "arm2_eef_quat", "target_pose"]
  # action_dim: 13  (arm2(7) + hand2(6))
  # 
  # 如果 use_velocity=true，添加速度观测:
  # obs_keys: ["chest_camera_rgb", "head_camera_rgb", "arm2_pos", "arm2_vel", "hand2_pos", "hand2_vel", "arm2_eef_pos", "arm2_eef_quat", "target_pose"]
  # 
  # 如果 use_third_camera=true，添加第三人称相机:
  # obs_keys: ["chest_camera_rgb", "head_camera_rgb", "third_camera_rgb", "arm2_pos", "hand2_pos", "arm2_eef_pos", "arm2_eef_quat", "target_pose"]
  # 
  # 如果 use_left_hand=true，添加左手观测（适用于双手交接任务）:
  # obs_keys: ["chest_camera_rgb", "head_camera_rgb", "third_camera_rgb", "arm2_pos", "hand2_pos", "arm2_eef_pos", "arm2_eef_quat", "arm1_pos", "hand1_pos", "arm1_eef_pos", "arm1_eef_quat", "target_pose"]
  # action_dim: 26  (右手13 + 左手13)
  # 
  # 当前配置（第三人称相机 + 双手观测）:
  obs_keys: ["chest_camera_rgb", "head_camera_rgb", "third_camera_rgb", "arm2_pos", "hand2_pos", "arm2_eef_pos", "arm2_eef_quat", "arm1_pos", "hand1_pos", "arm1_eef_pos", "arm1_eef_quat", "target_pose"]
  action_dim: 26             # 动作维度: 右手 arm2(7) + hand2(6) + 左手 arm1(7) + hand1(6) = 26
  image_size: 224            # 图像尺寸

# ==================== 图像通道配置 ====================
# 根据 obs_mode 设置图像通道数和图像形状
# rgb: 3通道, rgbm: 4通道, rgb_masked: 3通道, rgb_masked_rgb: 6通道, nd: 4通道, rgbnd: 7通道
# 【重要】修改 obs_mode 后需要同步修改 image_channels 和 image_shape 的第一个值！
image_channels: 4  # rgb=3, rgbm=4, rgb_masked=3, rgb_masked_rgb=6, nd=4, rgbnd=7

# 当前使用的图像形状 [channels, height, width]
image_shape:
  - 4    # 通道数: rgb=3, rgbm=4, rgb_masked=3, rgb_masked_rgb=6, nd=4, rgbnd=7
  - 224  # 高度
  - 224  # 宽度

# ==================== 形状元数据配置 ====================
shape_meta: &shape_meta
  # acceptable types: rgb, rgbm, rgb_masked, rgb_masked_rgb, nd, rgbnd, low_dim
  obs:
    # 胸部相机图像 (通道数根据 obs_mode 变化)
    chest_camera_rgb:
      shape: ${task.image_shape}
      type: ${task.obs_config.obs_mode}
      horizon: ${n_obs_steps}
    # 头部相机图像 (通道数根据 obs_mode 变化)
    head_camera_rgb:
      shape: ${task.image_shape}
      type: ${task.obs_config.obs_mode}
      horizon: ${n_obs_steps}
    # 第三人称相机图像 (可选，通道数根据 obs_mode 变化)
    # 注意：只有当 use_third_camera=true 时才启用，需要手动取消注释
    third_camera_rgb:
      shape: ${task.image_shape}
      type: ${task.obs_config.obs_mode}
      horizon: ${n_obs_steps}
    arm2_pos:
      shape: [7]
      type: low_dim 
      horizon: ${n_obs_steps} 
    # ===== 速度观测（根据 use_velocity 配置）=====
    # arm2_vel:
    #   shape: [7]
    #   type: low_dim 
    #   horizon: ${n_obs_steps} 
    hand2_pos:
      shape: [6]
      type: low_dim
      horizon: ${n_obs_steps}
    # hand2_vel:
    #   shape: [6]
    #   type: low_dim
    #   horizon: ${n_obs_steps}
    # ===== 速度观测结束 =====
    arm2_eef_pos:
      shape: [3]
      type: low_dim
      horizon: ${n_obs_steps}
    arm2_eef_quat:
      shape: [4]
      type: low_dim
      horizon: ${n_obs_steps}
    # ===== 左手观测（根据 use_left_hand 配置，用于双手交接任务）=====
    arm1_pos:
      shape: [7]
      type: low_dim
      horizon: ${n_obs_steps}
    # arm1_vel:
    #   shape: [7]
    #   type: low_dim
    #   horizon: ${n_obs_steps}
    hand1_pos:
      shape: [6]
      type: low_dim
      horizon: ${n_obs_steps}
    # hand1_vel:
    #   shape: [6]
    #   type: low_dim
    #   horizon: ${n_obs_steps}
    arm1_eef_pos:
      shape: [3]
      type: low_dim
      horizon: ${n_obs_steps}
    arm1_eef_quat:
      shape: [4]
      type: low_dim
      horizon: ${n_obs_steps}
    # ===== 左手观测结束 =====
    # 目标物体位姿
    target_pose:
      shape: [7]
      type: low_dim
      horizon: ${n_obs_steps}
  action: 
    shape: [26]  # 双手动作: 右手(13) + 左手(13) = 26
    horizon: ${n_action_steps}

env_runner:
  _target_: diffusion_policy.env_runner.real_pusht_image_runner.RealPushTImageRunner

# 使用多模式图像数据集
dataset:
  _target_: psi_dp.dataset.multi_modal_image_dataset.MultiModalImageDataset
  zarr_path: ${task.dataset_path}
  horizon: ${n_action_steps}
  pad_before: ${eval:'${n_obs_steps}-1+${n_latency_steps}'}
  pad_after: ${eval:'${n_action_steps}-1'}
  seed: 42
  val_ratio: 0
  obs_mode: ${task.obs_config.obs_mode}      # 图像观测模式
  use_velocity: ${task.obs_config.use_velocity}  # 是否使用速度观测
  use_third_camera: ${task.obs_config.use_third_camera}  # 是否使用第三人称相机
  use_left_hand: ${task.obs_config.use_left_hand}  # 是否使用左手观测（双手交接任务）
